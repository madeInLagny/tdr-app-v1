!function(){"use strict";function l(t){var e=t;return{get:function(){return e},set:function(t){e=t}}}function o(){}function t(){return v}function i(n){function t(){return r}function e(t){return t(n)}var o=m(n),r={fold:function(t,e){return e(n)},is:function(t){return n===t},isSome:p,isNone:g,getOr:o,getOrThunk:o,getOrDie:o,getOrNull:o,getOrUndefined:o,or:t,orThunk:t,map:function(t){return i(t(n))},each:function(t){t(n)},bind:e,exists:e,forall:e,filter:function(t){return t(n)?r:v},toArray:function(){return[n]},toString:function(){return"some("+n+")"},equals:function(t){return t.is(n)},equals_:function(t,e){return t.fold(g,function(t){return e(n,t)})}};return r}var e,n,u,r,a,c,s,f,S=tinymce.util.Tools.resolve("tinymce.PluginManager"),d=tinymce.util.Tools.resolve("tinymce.util.Tools"),h=function(t){return!(null==t)},m=function(t){return function(){return t}},g=m(!"function"),p=m(!0),v=(e=function(t){return t.isNone()},{fold:function(t,e){return t()},is:g,isSome:g,isNone:p,getOr:r=function(t){return t},getOrThunk:n=function(t){return t()},getOrDie:function(t){throw new Error(t||"error: getOrDie called on none.")},getOrNull:m(null),getOrUndefined:m(void 0),or:r,orThunk:n,map:t,each:o,bind:t,exists:g,forall:p,filter:t,equals:e,equals_:e,toArray:function(){return[]},toString:m("none()")}),y={some:i,none:t,from:function(t){return null==t?v:i(t)}},w=function(t,e){return n=document.createElement("canvas"),e=e,n.width=t,n.height=e,n;var n},B=function(t){var e=w(t.width,t.height);return b(e).drawImage(t,0,0),e},b=function(t){return t.getContext("2d")},I=window.Promise||(u=function(t){if("object"!=typeof this)throw new TypeError("Promises must be constructed via new");if("function"!=typeof t)throw new TypeError("not a function");this._state=null,this._value=null,this._deferreds=[],f(t,c(_,this),c(R,this))},r=window,a=u.immediateFn||"function"==typeof r.setImmediate&&r.setImmediate||function(t){return setTimeout(t,1)},c=function(n,o){return function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return n.apply(o,t)}},s=Array.isArray||function(t){return"[object Array]"===Object.prototype.toString.call(t)},f=function(t,e,n){var o=!1;try{t(function(t){o||(o=!0,e(t))},function(t){o||(o=!0,n(t))})}catch(t){o||(o=!0,n(t))}},u.prototype.catch=function(t){return this.then(null,t)},u.prototype.then=function(n,o){var r=this;return new u(function(t,e){T.call(r,new N(n,o,t,e))})},u.all=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var a=Array.prototype.slice.call(1===t.length&&s(t[0])?t[0]:t);return new u(function(o,r){if(0===a.length)return o([]);for(var i=a.length,u=function(e,t){try{if(t&&("object"==typeof t||"function"==typeof t)){var n=t.then;if("function"==typeof n)return void n.call(t,function(t){u(e,t)},r)}a[e]=t,0==--i&&o(a)}catch(t){r(t)}},t=0;t<a.length;t++)u(t,a[t])})},u.resolve=function(e){return e&&"object"==typeof e&&e.constructor===u?e:new u(function(t){t(e)})},u.reject=function(n){return new u(function(t,e){e(n)})},u.race=function(r){return new u(function(t,e){for(var n=0,o=r;n<o.length;n++)o[n].then(t,e)})},u);function T(n){var o=this;null!==this._state?a(function(){var t,e=o._state?n.onFulfilled:n.onRejected;if(null!==e){try{t=e(o._value)}catch(t){return void n.reject(t)}n.resolve(t)}else(o._state?n.resolve:n.reject)(o._value)}):this._deferreds.push(n)}function _(t){try{if(t===this)throw new TypeError("A promise cannot be resolved with itself.");if(t&&("object"==typeof t||"function"==typeof t)){var e=t.then;if("function"==typeof e)return void f(c(e,t),c(_,this),c(R,this))}this._state=!0,this._value=t,U.call(this)}catch(t){R.call(this,t)}}function R(t){this._state=!1,this._value=t,U.call(this)}function U(){for(var t=0,e=this._deferreds;t<e.length;t++){var n=e[t];T.call(this,n)}this._deferreds=[]}function N(t,e,n,o){this.onFulfilled="function"==typeof t?t:null,this.onRejected="function"==typeof e?e:null,this.resolve=n,this.reject=o}function D(o){return new I(function(t,e){var n=new XMLHttpRequest;n.open("GET",o,!0),n.responseType="blob",n.onload=function(){200===this.status&&t(this.response)},n.onerror=function(){var t;e(0===this.status?((t=new Error("No access to download image")).code=18,t.name="SecurityError",t):new Error("Error "+this.status+" downloading image"))},n.send()})}function A(t,e){for(var n=t,o=e,r=g,i=0,u=n.length;i<u;i++){var a=n[i];if(o(a,i))return y.some(a);if(r(a,i))break}return y.none()}function x(t,e,n){function o(e,n){return t.then(function(t){return t.toDataURL(e||"image/png",n)})}var r=e.type,r=m(r),i=m(n);return{getType:r,toBlob:function(){return I.resolve(e)},toDataURL:i,toBase64:function(){return n.split(",")[1]},toAdjustedBlob:function(e,n){return t.then(function(t){return nt(t,e,n)})},toAdjustedDataURL:o,toAdjustedBase64:function(t,e){return o(t,e).then(function(t){return t.split(",")[1]})},toCanvas:function(){return t.then(B)}}}function E(e,t){return nt(e,t).then(function(t){return x(I.resolve(e),t,e.toDataURL())})}function M(t,e){return void 0===e&&(e=2),e=Math.pow(10,e),t=Math.round(t*e),Math.ceil(t/e)}function L(c,s,l){return void 0===l&&(l=!1),new I(function(t){for(var e,n=new XMLHttpRequest,o=(n.onreadystatechange=function(){4===n.readyState&&t({status:n.status,blob:n.response})},n.open("GET",c,!0),n.withCredentials=l,s),r=at(o),i=0,u=r.length;i<u;i++){var a=r[i];e=o[a],n.setRequestHeader(a,e)}n.responseType="blob",n.send()})}function F(t,e){u=function(t,e){return h(t)?t[e]:void 0},a=t;for(var n,o=e,r=0,i=o.length;r<i;r++)n=o[r],a=u(a,n);var u,a,t=a;return y.from(t)}function H(t){e=t;var e,t="ImageProxy HTTP error: "+A(ct,function(t){return e===t.code}).fold(m("Unknown ImageProxy error"),function(t){return t.message});return I.reject(t)}function q(e){return A(st,function(t){return t.type===e}).fold(m("Unknown service error"),function(t){return t.message})}function z(t){return o=t,new I(function(t,e){var n=new FileReader;n.onload=function(){t(n.result)},n.onerror=function(t){e(t)},n.readAsText(o)}).then(function(t){t="ImageProxy Service error: "+function(t){try{return y.some(JSON.parse(t))}catch(t){return y.none()}}(t).bind(function(t){return F(t,["error","type"]).map(q)}).getOr("Invalid JSON in service error message");return I.reject(t)});var o}function $(t){return t<200||300<=t}function G(t,e,n){return void 0===n&&(n=!1),e?(i={"Content-Type":"application/json;charset=UTF-8","tiny-api-key":o=e},L((o=e,r=-1===(e=e=t).indexOf("?")?"?":"&",/[?&]apiKey=/.test(e)?e:e+r+"apiKey="+encodeURIComponent(o)),i).then(function(t){return $(t.status)?(e=t.status,"application/json"!==(null==(n=t.blob)?void 0:n.type)||400!==e&&403!==e&&404!==e&&500!==e?H(e):z(n)):I.resolve(t.blob);var e,n})):L(t,{},n).then(function(t){return $(t.status)?H(t.status):I.resolve(t.blob)});var o,r,i}function j(t){if(null==t)throw new Error("Node cannot be null or undefined");return{dom:t}}function J(t,n){return e=function(t){var e=n,t=t.dom;if(1!==t.nodeType)return!1;if(void 0!==t.matches)return t.matches(e);if(void 0!==t.msMatchesSelector)return t.msMatchesSelector(e);if(void 0!==t.webkitMatchesSelector)return t.webkitMatchesSelector(e);if(void 0!==t.mozMatchesSelector)return t.mozMatchesSelector(e);throw new Error("Browser lacks native selectors")},A(t.dom.childNodes,function(t){return e(C.fromDom(t))}).map(C.fromDom);var e}function k(e,t){function n(t){return wt(e,t)&&(It(e,t)||Tt(e,t)||h(mt(e)))}return yt(e,t)?vt(t).bind(function(t){return n(t.dom)?y.some(t.dom):y.none()}):n(t)?y.some(t):y.none()}function K(t,e,n){return e=e.match(/(?:\/|^)(([^\/\?]+)\.(?:[a-z0-9.]+))(?:\?|$)/i),h(e)?t.dom.encode(e[n]):null}function V(t,e){var n,o;return Tt(t,e)?G(e.src,null,(n=e,-1!==d.inArray(t.getParam("imagetools_credentials_hosts",[],"string[]"),new O(n.src).host))):It(t,e)?(0===(n=(n=e).src).indexOf("data:")?et:D)(n):(o=(o=mt(t))+(-1===o.indexOf("?")?"?":"&")+"url="+encodeURIComponent(e.src),e=t.getParam("api_key",t.getParam("imagetools_api_key","","string"),"string"),G(o,e,!1))}function W(t){ft.clearTimeout(t.get())}function X(o,r,t,i){return function(){return P(o).fold(function(){bt(o,"Could not find selected image")},function(n){return o._scanForImages().then(function(){return Rt(o,n.dom)}).then(function(e){return lt(e).then(t).then(function(t){return Ut(o,e,t,!1,r,n.dom,i)})}).catch(function(t){bt(o,t)})})}}function Q(e,n,o){return function(){var t=P(e).fold(function(){return null},function(t){t=ht(t.dom);return t?{w:t.h,h:t.w}:null});return X(e,n,function(t){return n=o,(e=t).toCanvas().then(function(t){return it(t,e.getType(),n)});var e,n},t)()}}function Y(t,e,o){return function(){return X(t,e,function(t){return n=o,(e=t).toCanvas().then(function(t){return ut(t,e.getType(),n)});var e,n})()}}function Z(c,s){return function(){var n=P(c),i=n.map(function(t){return gt(t.dom)});n.each(function(e){k(c,e.dom).each(function(t){Rt(c,e.dom).then(function(t){t={blob:t,url:URL.createObjectURL(t)};c.windowManager.open({title:"Edit Image",size:"large",body:{type:"panel",items:[{type:"imagetools",name:"imagetools",label:"Edit Image",currentState:t}]},buttons:[{type:"cancel",name:"cancel",text:"Cancel"},{type:"submit",name:"save",text:"Save",primary:!0,disabled:!0}],onSubmit:function(t){var r=t.getData().imagetools.blob;n.each(function(o){i.each(function(t){var e,n,i,u,a;e=c,n=s,i=o.dom,u=t,rt(a=r).then(function(t){var e,n,o,r=gt(t);return u.w===r.w&&u.h===r.h||ht(i)&&(e=i,r=r)&&(n=e.style.width,o=e.style.height,(n||o)&&(e.style.width=r.w+"px",e.style.height=r.h+"px",e.removeAttribute("data-mce-style")),n=e.width,o=e.height,n||o)&&(e.setAttribute("width",String(r.w)),e.setAttribute("height",String(r.h))),URL.revokeObjectURL(t.src),a}).then(lt).then(function(t){return Ut(e,a,t,!0,n,i)})})}),t.close()},onCancel:o,onAction:function(t,e){switch(e.name){case"save-state":e.value?t.enable("save"):t.disable("save");break;case"disable":t.disable("save"),t.disable("cancel");break;case"enable":t.enable("cancel")}}})})})})}}var tt=function(a){return new I(function(t,e){function n(){u(),t(i)}function o(){u(),e("Unable to load data of type "+a.type+": "+r)}var r=URL.createObjectURL(a),i=new Image,u=function(){i.removeEventListener("load",n),i.removeEventListener("error",o)};i.addEventListener("load",n),i.addEventListener("error",o),i.src=r,i.complete&&setTimeout(n,0)})},et=function(d){return new I(function(t,e){!function(){var t=d.split(","),e=/data:([^;]+)/.exec(t[0]);if(!e)return y.none();for(var e=e[1],t=t[1],n=atob(t),o=n.length,r=Math.ceil(o/1024),i=new Array(r),u=0;u<r;++u){for(var a=1024*u,c=Math.min(1024+a,o),s=new Array(c-a),l=a,f=0;l<c;++f,++l)s[f]=n[l].charCodeAt(0);i[u]=new Uint8Array(s)}return y.some(new Blob(i,{type:e}))}().fold(function(){e("uri is not base64: "+d)},t)})},nt=function(t,o,r){return o=o||"image/png","function"==typeof HTMLCanvasElement.prototype.toBlob?new I(function(e,n){t.toBlob(function(t){t?e(t):n()},o,r)}):et(t.toDataURL(o,r))},ot=function(t){URL.revokeObjectURL(t.src)},rt=tt,it=function(t,e,n){var n=(n<0?360+n:n)*Math.PI/180,o=t.width,r=t.height,i=Math.sin(n),u=Math.cos(n),a=M(Math.abs(o*u)+Math.abs(r*i)),i=M(Math.abs(o*i)+Math.abs(r*u)),u=w(a,i),c=b(u);return c.translate(a/2,i/2),c.rotate(n),c.drawImage(t,-o/2,-r/2),E(u,e)},ut=function(t,e,n){var o=w(t.width,t.height),r=b(o);return"v"===n?(r.scale(1,-1),r.drawImage(t,0,-o.height)):(r.scale(-1,1),r.drawImage(t,-o.width,0)),E(o,e)},at=Object.keys,ct=[{code:404,message:"Could not find Image Proxy"},{code:403,message:"Rejected request"},{code:0,message:"Incorrect Image Proxy URL"}],st=[{type:"not_found",message:"Failed to load image."},{type:"key_missing",message:"The request did not include an api key."},{type:"key_not_found",message:"The provided api key could not be found."},{type:"domain_not_trusted",message:"The api key is not valid for the request origins."}],lt=function(e){return n=e,new I(function(t){var e=new FileReader;e.onloadend=function(){t(e.result)},e.readAsDataURL(n)}).then(function(t){return x(tt(e).then(function(t){ot(t);var e=w(t.naturalWidth||t.width,t.naturalHeight||t.height);return b(e).drawImage(t,0,0),e}),e,t)});var n},C={fromHtml:function(t,e){e=(e||document).createElement("div");if(e.innerHTML=t,!e.hasChildNodes()||1<e.childNodes.length)throw console.error("HTML does not have a single root node",t),new Error("HTML must have a single root node");return j(e.childNodes[0])},fromTag:function(t,e){e=(e||document).createElement(t);return j(e)},fromText:function(t,e){e=(e||document).createTextNode(t);return j(e)},fromDom:j,fromPoint:function(t,e,n){return y.from(t.dom.elementFromPoint(e,n)).map(j)}},ft=("undefined"==typeof window&&Function("return this;")(),tinymce.util.Tools.resolve("tinymce.util.Delay")),dt=tinymce.util.Tools.resolve("tinymce.util.Promise"),O=tinymce.util.Tools.resolve("tinymce.util.URI"),mt=function(t){return t.getParam("imagetools_proxy")},ht=function(t){function e(t){return/^[0-9\.]+px$/.test(t)}var n=t.style.width,o=t.style.height;return n||o?e(n)&&e(o)?{w:parseInt(n,10),h:parseInt(o,10)}:null:(n=t.width,o=t.height,n&&o?{w:parseInt(n,10),h:parseInt(o,10)}:null)},gt=function(t){return{w:t.naturalWidth,h:t.naturalHeight}},pt=0,vt=function(t){return J(C.fromDom(t),"img")},yt=function(t,e){return t.dom.is(e,"figure")},wt=function(t,e){return t.dom.is(e,"img:not([data-mce-object],[data-mce-placeholder])")},bt=function(t,e){t.notificationManager.open({text:e,type:"error"})},P=function(t){var e=t.selection.getNode(),n=t.dom.getParent(e,"figure.image");return null!==n&&yt(t,n)?vt(n):wt(t,e)?y.some(C.fromDom(e)):y.none()},It=function(t,e){e=e.src;return 0===e.indexOf("data:")||0===e.indexOf("blob:")||new O(e).host===t.documentBaseURI.host},Tt=function(t,e){return-1!==d.inArray(t.getParam("imagetools_cors_hosts",[],"string[]"),new O(e.src).host)},_t=function(t,e){return y.from(t.getParam("imagetools_fetch_image",null,"function")).fold(function(){return V(t,e)},function(t){return t(e)})},Rt=function(t,e){var n=t.editorUpload.blobCache.getByUri(e.src);return n?dt.resolve(n.blob()):_t(t,e)},Ut=function(a,c,s,l,f,d,m){return s.toBlob().then(function(t){var e,n,r,o=a.editorUpload.blobCache,i=d.src,u=c.type===t.type;return a.getParam("images_reuse_filename",!1,"boolean")&&(r=o.getByUri(i),n=h(r)?(i=r.uri(),e=r.name(),r.filename()):(e=K(a,i,2),K(a,i,1))),r=o.create({id:"imagetools"+pt++,blob:t,base64:s.toBase64(),uri:i,name:e,filename:u?n:void 0}),o.add(r),a.undoManager.transact(function(){var o=function(){var t,e,n;a.$(d).off("load",o),a.nodeChanged(),l?a.editorUpload.uploadImagesAuto():(W(f),t=a,e=f,n=ft.setEditorTimeout(t,function(){t.editorUpload.uploadImagesAuto()},t.getParam("images_upload_timeout",3e4,"number")),e.set(n))};a.$(d).on("load",o),m&&a.$(d).attr({width:m.w,height:m.h}),a.$(d).attr({src:r.blobUri()}).removeAttr("data-mce-src")}),r})};S.add("imagetools",function(t){var n,e,o,r,i,u,a=l(0),c=l(null),s=t;d.each({mceImageRotateLeft:Q(s,a,-90),mceImageRotateRight:Q(s,a,90),mceImageFlipVertical:Y(s,a,"v"),mceImageFlipHorizontal:Y(s,a,"h"),mceEditImage:Z(s,a)},function(t,e){s.addCommand(e,t)}),(n=t).ui.registry.addButton("rotateleft",{tooltip:"Rotate counterclockwise",icon:"rotate-left",onAction:(e=function(t){return function(){return n.execCommand(t)}})("mceImageRotateLeft")}),n.ui.registry.addButton("rotateright",{tooltip:"Rotate clockwise",icon:"rotate-right",onAction:e("mceImageRotateRight")}),n.ui.registry.addButton("flipv",{tooltip:"Flip vertically",icon:"flip-vertically",onAction:e("mceImageFlipVertical")}),n.ui.registry.addButton("fliph",{tooltip:"Flip horizontally",icon:"flip-horizontally",onAction:e("mceImageFlipHorizontal")}),n.ui.registry.addButton("editimage",{tooltip:"Edit image",icon:"edit-image",onAction:e("mceEditImage"),onSetup:function(e){function t(){var t=P(n).forall(function(t){return k(n,t.dom).isNone()});e.setDisabled(t)}return n.on("NodeChange",t),function(){n.off("NodeChange",t)}}}),n.ui.registry.addButton("imageoptions",{tooltip:"Image options",icon:"image",onAction:e("mceImage")}),n.ui.registry.addContextMenu("imagetools",{update:function(t){return k(n,t).fold(function(){return[]},function(t){return[{text:"Edit image",icon:"edit-image",onAction:e("mceEditImage")}]})}}),(o=t).ui.registry.addContextToolbar("imagetools",{items:o.getParam("imagetools_toolbar","rotateleft rotateright flipv fliph editimage imageoptions"),predicate:function(t){return k(o,t).isSome()},position:"node",scope:"node"}),i=a,u=c,(r=t).on("NodeChange",function(t){var e=u.get(),t=k(r,t.element);e&&!t.exists(function(t){return e.src===t.src})&&(W(i),r.editorUpload.uploadImagesAuto(),u.set(null)),t.each(u.set)})})}();